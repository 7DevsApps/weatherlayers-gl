<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>kamzek-weather</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="../dist/weather-gl-old.umd.min.js"></script>
    <link href="./style.css" rel="stylesheet">
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
    </div>

<script type="module">
import { getUrl, colorFunctions, loadConfig, initGui } from './config.js';

window.addEventListener('DOMContentLoaded', async () => {
    const config = await loadConfig();

    const canvas = document.getElementById('canvas');
    const gl = canvas.getContext('webgl', { alpha: true, premultipliedAlpha: true });

    let overlayGl;
    let particlesGl;

    let resizeObserver;
    function initResizeObserver() {
        if (typeof window.ResizeObserver !== 'undefined') {
            resizeObserver = new window.ResizeObserver(update);
            resizeObserver.observe(canvas.parentElement);
        } else {
            window.addEventListener('resize', update);
        }
    }
    initResizeObserver();

    let lastFrameTime = 0;
    let running = false;
    let raf = null;
    function frame() {
        const fps = 30;
        const fpsInterval = 1000 / fps;
        const now = Date.now();
        const elapsed = now - lastFrameTime;

        if (elapsed > fpsInterval) {
            lastFrameTime = now - (elapsed % fpsInterval);

            gl.clearColor(0, 0, 0, 0);
            gl.clear(gl.COLOR_BUFFER_BIT);

            const matrix = [
                2, 0, 0, 0,
                0, -2, 0, 0,
                0, 0, 1, 0,
                -1, 1, 0, 1,
            ];
            const bounds = [[0, 0], [1, 1]];

            overlayGl.render(matrix, bounds);
            particlesGl.prerender(matrix, bounds, 0);
            particlesGl.render();
        }

        if (running) {
            raf = requestAnimationFrame(frame);
        }
    }
    function start() {
        if (running) {
            return;
        }

        running = true;
        frame();
    }
    function stop() {
        if (!running) {
            return;
        }

        running = false;
        if (raf) {
            cancelAnimationFrame(raf);
            raf = null;
        }
    }
    function step() {
        if (!running) {
            frame();
        }
    }

    // weather layers
    async function update() {
        const pixelRatio = window.devicePixelRatio || 1;
        canvas.width = canvas.parentElement.clientWidth * pixelRatio;
        canvas.height = canvas.parentElement.clientHeight * pixelRatio;
        const overlayUrl = getUrl(config.datasets, config.meta.dataset, config.meta.datetime);
        const particlesUrl = getUrl(config.datasets, config.meta.particles.dataset, config.meta.particles.datetime);
        config.overlay.colorFunction = colorFunctions.get(config.meta.overlay.colorFunction);
        config.overlay.image = await WeatherGl.loadImage(overlayUrl, config.overlay.imageBounds, { vector: config.overlay.vector, vectorToScalar: true });
        config.particles.image = await WeatherGl.loadImage(particlesUrl, config.particles.imageBounds, { vector: true });

        if (!overlayGl) {
            overlayGl = WeatherGl.overlayGl(gl, config.overlay);
        } else {
            overlayGl.update();
        }
        if (!particlesGl) {
            particlesGl = WeatherGl.particlesGl(gl, config.particles);
            start();
        } else {
            particlesGl.update();
        }
    }
    update();

    // GUI
    const meta = {
        running: true,
        step: () => step(),
    };
    const gui = initGui(config, update, true);
    const debug = gui.addFolder('debug');
    debug.add(meta, 'running').onChange(() => {
        if (meta.running) {
            start();
        } else {
            stop();
        }
    });
    debug.add(meta, 'step');
});
</script>
</body>
</html>
