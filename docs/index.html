<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>maritrace-mapbox-weather</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="../dist/maritrace-mapbox-weather.umd.js"></script>
    <style>
        body {
            margin: 0;
            background: #000;
        }
        #canvas {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

<script type="module">
import { config, initGui } from './config.js';

config.overlay.opacity = 0.4;
config.particles.speedFactor = 0.15;

window.addEventListener('DOMContentLoaded', async () => {
    config.overlay.image = await MaritraceMapboxWeather.loadImage(config.overlay.imagePath);
    config.particles.image = await MaritraceMapboxWeather.loadImage(config.particles.imagePath);
    
    const canvas = document.getElementById('canvas');

    const pixelRatio = MaritraceMapboxWeather.getPixelRatio(config.particles.retina);
    canvas.width = canvas.parentElement.clientWidth * pixelRatio;
    canvas.height = canvas.parentElement.clientHeight * pixelRatio;

    const gl = canvas.getContext('webgl', { alpha: true, premultipliedAlpha: true });
    const overlayGl = MaritraceMapboxWeather.overlayGl(gl, config.overlay);
    const particlesGl = MaritraceMapboxWeather.particlesGl(gl, config.particles);

    let resizeObserver;
    function initResizeObserver() {
        if (typeof window.ResizeObserver !== 'undefined') {
            resizeObserver = new window.ResizeObserver(update);
            resizeObserver.observe(canvas.parentElement);
        } else {
            window.addEventListener('resize', update);
        }
    }
    initResizeObserver();

    let running = false;
    let raf = null;
    function frame() {
        gl.clearColor(0, 0, 0, 0);
        gl.clear(gl.COLOR_BUFFER_BIT);

        const matrix = [
            2, 0, 0, 0,
            0, -2, 0, 0,
            0, 0, 1, 0,
            -1, 1, 0, 1,
        ];
        const worldBounds = [[0, 0], [1, 1]];

        overlayGl.render(matrix, worldBounds);
        particlesGl.prerender(matrix, worldBounds, 0);
        particlesGl.render();

        if (running) {
            raf = requestAnimationFrame(frame);
        }
    }
    function start() {
        if (running) {
            return;
        }

        running = true;
        frame();
    }
    function stop() {
        if (!running) {
            return;
        }

        running = false;
        if (raf) {
            cancelAnimationFrame(raf);
            raf = null;
        }
    }
    function step() {
        if (!running) {
            frame();
        }
    }

    start();

    const meta = {
        running: true,
        step: () => step(),
    };
    async function update() {
        const pixelRatio = MaritraceMapboxWeather.getPixelRatio(config.particles.retina);
        canvas.width = canvas.parentElement.clientWidth * pixelRatio;
        canvas.height = canvas.parentElement.clientHeight * pixelRatio;

        config.overlay.image = await MaritraceMapboxWeather.loadImage(config.overlay.imagePath);
        config.particles.image = await MaritraceMapboxWeather.loadImage(config.particles.imagePath);

        overlayGl.update();
        particlesGl.update();
    }
    const gui = initGui(config, update);
    gui.add(meta, 'running').onChange(() => {
        if (meta.running) {
            start();
        } else {
            stop();
        }
    });
    gui.add(meta, 'step');
});
</script>
</body>
</html>
