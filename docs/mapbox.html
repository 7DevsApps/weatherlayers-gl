<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>kamzek-weather</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.13.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.13.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="../dist/weather-gl.umd.min.js"></script>
    <link href="./style.css" rel="stylesheet">
</head>
<body>
    <div id="container">
        <div id="mapbox"></div>
    </div>
    <div id="info">
        <div id="info1"></div>
        <div id="info2"></div>
    </div>

<script type="module">
import { getUrl, colorFunctions, loadConfig, initGui } from './config.js';

function formatNumber(value, decimals = 6) {
    return Math.floor(value * 10 ** decimals) / 10 ** decimals;
}

window.addEventListener('DOMContentLoaded', async () => {
    const config = await loadConfig();

    const map = new mapboxgl.Map({
        container: 'mapbox',
        accessToken: 'pk.eyJ1IjoiemFramFuIiwiYSI6IlB6c09JTjQifQ.pGUFp8k7f-W9IAkCrM_PYQ',
        style: 'mapbox://styles/mapbox/dark-v10',
        center: [30, 0],
        zoom: 0,
        // FIXME: overzoomed particles don't move
        // center: [6.696399, 55.020684],
        // zoom: 15.5,
    });

    let legendControl;
    let overlayLayer;
    let particlesLayer;

    function updateInfo() {
        const geographicCenter = WeatherGl.getGeographicPosition(map.getCenter());
        const mercatorCenter = WeatherGl.getMercatorPosition(map.getCenter());
        const bounds = map.getBounds();
        const geographicWorldBounds = [WeatherGl.getGeographicPosition(bounds.getNorthWest()), WeatherGl.getGeographicPosition(bounds.getSouthEast())];
        const mercatorWorldBounds = [WeatherGl.getMercatorPosition(bounds.getNorthWest()), WeatherGl.getMercatorPosition(bounds.getSouthEast())];
        const matrix = map.transform.customLayerMatrix();

        document.getElementById('info1').innerHTML = `
            Center: ${map.getCenter().toArray().map(x => formatNumber(x)).join(', ')}<br>
            Center (geographic): ${formatNumber(geographicCenter[0])}, ${formatNumber(geographicCenter[1])}<br>
            Center (mercator): ${formatNumber(mercatorCenter[0])}, ${formatNumber(mercatorCenter[1])}<br>
            Zoom: ${formatNumber(map.getZoom())}<br>
            Pitch: ${formatNumber(map.getPitch())}<br>
            Bearing: ${formatNumber(map.getBearing())}
            <br>
            Bounds:<br>
            <div class="grid-2">
                ${bounds.getSouthWest().toArray().map((x, i, array) => `<span>${formatNumber(x)}${i < array.length - 1 ? ',' : ''}</span>`).join('')}
                ${bounds.getNorthEast().toArray().map((x, i, array) => `<span>${formatNumber(x)}${i < array.length - 1 ? ',' : ''}</span>`).join('')}
            </div><br>
            <br>
            Bounds (geographic):<br>
            <div class="grid-2">
                ${geographicWorldBounds[0].map((x, i, array) => `<span>${formatNumber(x)}${i < array.length - 1 ? ',' : ''}</span>`).join('')}
                ${geographicWorldBounds[1].map((x, i, array) => `<span>${formatNumber(x)}${i < array.length - 1 ? ',' : ''}</span>`).join('')}
            </div><br>
            <br>
            Bounds (mercator):<br>
            <div class="grid-2">
                ${mercatorWorldBounds[0].map((x, i, array) => `<span>${formatNumber(x)}${i < array.length - 1 ? ',' : ''}</span>`).join('')}
                ${mercatorWorldBounds[1].map((x, i, array) => `<span>${formatNumber(x)}${i < array.length - 1 ? ',' : ''}</span>`).join('')}
            </div><br>
            <br>
            Matrix:<br>
            <div class="grid-4">
                ${matrix.map((x, i) => `<span>${Math.round(x)}${i < matrix.length - 1 ? ',' : ''}</span>`).join('')}
            </div><br>
        `;
    };
    function updateMouseInfo(event) {
        const geographicPosition = WeatherGl.getGeographicPosition(event.lngLat);
        const mercatorPosition = WeatherGl.getMercatorPosition(event.lngLat);
        const overlayValue = overlayLayer ? overlayLayer.getPositionValue(event.lngLat) : undefined;
        const particlesVector = particlesLayer ? particlesLayer.getPositionVector(event.lngLat) : undefined;
        const particlesBearing = particlesLayer ? particlesLayer.getPositionBearing(event.lngLat) : undefined;

        document.getElementById('info2').innerHTML = `
            Mouse:<br>
            Position: ${formatNumber(event.lngLat.lng)}, ${formatNumber(event.lngLat.lat)}<br>
            Position (geographic): ${formatNumber(geographicPosition[0])}, ${formatNumber(geographicPosition[1])}<br>
            Position (mercator): ${formatNumber(mercatorPosition[0])}, ${formatNumber(mercatorPosition[1])}<br>
            Overlay Value: ${typeof overlayValue !== 'undefined' ? formatNumber(overlayValue) : 'n/a'}<br>
            Particles Vector: ${typeof particlesVector !== 'undefined' ? `${formatNumber(particlesVector[0])}, ${formatNumber(particlesVector[1])}` : 'n/a'}<br>
            Particles Bearing: ${typeof particlesBearing !== 'undefined' ? Math.round(particlesBearing) : 'n/a'}
        `;
    }
    map.on('move', updateInfo);
    map.on('zoom', updateInfo);
    map.on('resize', updateInfo);
    map.on('mousemove', updateMouseInfo);
    updateInfo();

    map.on('load', () => {
        updateInfo();

        // weather layers
        async function update() {
            const overlayUrl = getUrl(config.datasets, config.meta.dataset, config.meta.datetime);
            const particlesUrl = getUrl(config.datasets, config.meta.particles.dataset, config.meta.particles.datetime);
            config.overlay.colorFunction = colorFunctions.get(config.meta.overlay.colorFunction);
            config.overlay.image = await WeatherGl.loadImage(overlayUrl, config.overlay.imageBounds, { vector: config.overlay.vector, vectorToScalar: true });
            config.particles.image = await WeatherGl.loadImage(particlesUrl, config.particles.imageBounds, { vector: true });

            if (!legendControl) {
                legendControl = new WeatherGl.LegendControl(config.overlay);
                map.addControl(legendControl, 'bottom-left');
            } else {
                legendControl.update();
            }
            if (!overlayLayer) {
                overlayLayer = new WeatherGl.OverlayLayer(config.overlay);
                map.addLayer(overlayLayer, 'waterway-label');
            } else {
                overlayLayer.update();
            }
            if (!particlesLayer) {
                particlesLayer = new WeatherGl.ParticlesLayer(config.particles);
                map.addLayer(particlesLayer, 'waterway-label');
            } else {
                particlesLayer.update();
            }
            map.triggerRepaint();
        }
        update();

        // GUI
        const meta = {
            running: true,
            step: () => particlesLayer.step(),
        };
        const gui = initGui(config, update, true);
        const debug = gui.addFolder('debug');
        debug.add(meta, 'running').onChange(() => {
            if (meta.running) {
                particlesLayer.start();
            } else {
                particlesLayer.stop();
            }
        });
        debug.add(meta, 'step');
    });
});
</script>
</body>
</html>