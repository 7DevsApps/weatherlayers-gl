<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>maritrace-mapbox-weather</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="../dist/maritrace-mapbox-weather.umd.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Lucida Grande', sans-serif;
            font-size: 12px;
        }
        #map {
            width: 100vw;
            height: 100vh;
        }
        #info {
            position: absolute;
            top: 0;
            left: 15px;
            padding: 4px 8px;
            background: #111;
            color: #eee;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info"></div>

<script type="module">
import { config, initGui } from './config.js';

function round(value) {
    return Math.floor(value * 10 ** 6) / 10 ** 6;
}

window.addEventListener('DOMContentLoaded', async () => {
    config.overlay.image = await MaritraceMapboxWeather.loadImage(config.overlay.imagePath);
    config.particles.image = await MaritraceMapboxWeather.loadImage(config.particles.imagePath);

    const map = new mapboxgl.Map({
        container: 'map',
        accessToken: 'pk.eyJ1IjoiemFramFuIiwiYSI6IlB6c09JTjQifQ.pGUFp8k7f-W9IAkCrM_PYQ',
        style: 'mapbox://styles/mapbox/dark-v10',
        zoom: 0,
        center: [30, 0],
        antialias: true,
    });

    const overlayLayer = new MaritraceMapboxWeather.OverlayLayer(config.overlay);
    const particlesLayer = new MaritraceMapboxWeather.ParticlesLayer(config.particles);
    const legendControl = new MaritraceMapboxWeather.LegendControl(config.overlay);
    let initialized = false;

    async function update() {
        config.overlay.image = await MaritraceMapboxWeather.loadImage(config.overlay.imagePath);
        config.particles.image = await MaritraceMapboxWeather.loadImage(config.particles.imagePath);

        overlayLayer.update();
        particlesLayer.update();
        legendControl.update();
        map.triggerRepaint();
    }
    function addGui() {
        if (!initialized) {
            setTimeout(addGui, 500);
            return;
        }
        const gui = initGui(config, update);
        gui.add(particlesLayer, 'running').onChange(update);
    }
    addGui();

    const info = document.getElementById('info');
    const updateInfo = () => {
        const matrix = map.transform.customLayerMatrix();
        const worldOffsets = MaritraceMapboxWeather.getWorldOffsets(map);
        const worldBounds = MaritraceMapboxWeather.getWorldBounds(map);

        info.innerHTML = `
            Position: ${round(map.getCenter().lat)}, ${round(map.getCenter().lng)}<br>
            Zoom: ${round(map.getZoom())}<br>
            Pitch: ${round(map.getPitch())}<br>
            Bearing: ${round(map.getBearing())}<br><br>
            Matrix: <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; grid-column-gap: 8px">${matrix.map((x, i) => `<span>${i === 0 ? '[' : ''}${Math.round(x)}${i === matrix.length - 1 ? ']' : ','}</span>`).join('')}</div><br>
            Bounds Min: ${round(worldBounds[0][0])}, ${round(worldBounds[0][1])}<br>
            Bounds Max: ${round(worldBounds[1][0])}, ${round(worldBounds[1][1])}<br>
            Offsets: ${worldOffsets.join(', ')}
        `;
    };
    map.on('move', updateInfo);
    map.on('zoom', updateInfo);
    map.on('resize', updateInfo);
    updateInfo();
    map.on('click', e => {
        const mercator = mapboxgl.MercatorCoordinate.fromLngLat(e.lngLat);
        const overlayValue = overlayLayer.getPositionValue(e.lngLat);
        const particlesBearing = particlesLayer.getPositionBearing(e.lngLat);

        info.innerHTML += `
            <br><br>
            Clicked:<br>
            ${round(e.lngLat.lat)}, ${round(e.lngLat.lng)}<br>
            ${round(mercator.x)}, ${round(mercator.y)}<br>
            ${round(overlayValue)}, ${round(particlesBearing)}
        `;
    });

    map.on('style.load', () => {
        map.addLayer(overlayLayer, 'waterway-label');
        map.addLayer(particlesLayer, 'waterway-label');
        map.addControl(legendControl, 'bottom-left');
        updateInfo();
        initialized = true;
    });
});
</script>
</body>
</html>