<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>maritrace-mapbox-weather</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
    <script src="../dist/maritrace-mapbox-weather.umd.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Lucida Grande', sans-serif;
            font-size: 12px;
        }
        #map {
            width: 100vw;
            height: 100vh;
        }
        #info {
            position: absolute;
            top: 0;
            left: 15px;
            padding: 4px 8px;
            background: #111;
            color: #eee;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="info"></div>

<script type="module">
import { config, initGui } from './config.js';

function round(value) {
    return Math.floor(value * 10 ** 6) / 10 ** 6;
}

window.addEventListener('DOMContentLoaded', async () => {
    config.weather.image = await MaritraceMapboxWeather.loadImage(config.weather.imagePath);

    const map = new mapboxgl.Map({
        container: 'map',
        accessToken: 'pk.eyJ1IjoiemFramFuIiwiYSI6IlB6c09JTjQifQ.pGUFp8k7f-W9IAkCrM_PYQ',
        style: 'mapbox://styles/mapbox/dark-v10',
        zoom: 0,
        center: [30, 0],
        antialias: true // create the gl context with MSAA antialiasing, so custom layers are antialiased
    });

    const info = document.getElementById('info');
    const updateInfo = () => {
        const matrix = map.transform.customLayerMatrix();
        let worlds = map.transform.getVisibleUnwrappedCoordinates({x: 0, y: 0, z: 0}).map(x => x.wrap).sort((a, b) => a - b);
        worlds = worlds.slice(1, worlds.length - 1);

        info.innerHTML = `
            Position: ${round(map.getCenter().lat)}, ${round(map.getCenter().lng)}<br>
            Zoom: ${round(map.getZoom())}<br>
            Pitch: ${round(map.getPitch())}<br>
            Bearing: ${round(map.getBearing())}<br>
            Worlds: ${worlds.join(', ')}<br><br>
            Matrix: <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; grid-column-gap: 8px">${matrix.map((x, i) => `<span>${i === 0 ? '[' : ''}${Math.round(x)}${i === matrix.length - 1 ? ']' : ','}</span>`).join('')}</div>
        `;
    };
    map.on('move', updateInfo);
    map.on('zoom', updateInfo);
    map.on('resize', updateInfo);
    updateInfo();

    map.on('style.load', () => {
        const weatherLayer = new MaritraceMapboxWeather.WeatherLayer(config);
        map.addLayer(weatherLayer, 'waterway-label');

        const colorLegend = new MaritraceMapboxWeather.ColorLegend(config.overlayColorRamp);
        map.addControl(colorLegend, 'bottom-left');

        function addGui() {
            if (!weatherLayer.weather) {
                setTimeout(addGui, 500);
                return;
            }

            const gui = initGui(weatherLayer.weather);
            gui.remove(gui.__controllers.find(c => c.property === 'running'));
            gui.add(weatherLayer, 'running').onChange(() => map.triggerRepaint());
        }
        addGui();
    });
});
</script>
</body>
</html>