<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>WeatherLayers</title>
  <script src="https://unpkg.com/tweakpane@3.0.5/dist/tweakpane.min.js"></script>
  <script src="https://unpkg.com/stats.js@0.17.0/build/stats.min.js"></script>
  <script src="https://unpkg.com/deck.gl@8.9.3/dist.min.js"></script>
  <script src="https://unpkg.com/geotiff@2.0.5/dist-browser/geotiff.js"></script>
  <script src="../../dist/weatherlayers-deck.umd.min.js"></script>
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="../info-control.css">
  <link rel="stylesheet" href="../fps-control.css">
  <script defer data-domain="demo.weatherlayers.com" data-api="/phq/api/event" src="/phq/js/script.js"></script>
</head>

<body>
  <div id="container">
    <div id="deck"></div>
  </div>
  <div id="top-left"></div>
  <div id="bottom-left"></div>
  <div id="bottom-right"></div>

  <script type="module">
    import { initConfig, initGui, colorToArray } from '../config.js';
    import { InfoControl } from '../info-control.js';
    import { FpsControl } from '../fps-control.js';
    import FRONT_DATA from './front-data.json' assert { type: 'json' };

    const FrontDataTypeToFrontType = {
      CFRONT: WeatherLayers.FrontType.COLD,
      WFRONT: WeatherLayers.FrontType.WARM,
      OFRONT: WeatherLayers.FrontType.OCCLUDED,
      SFRONT: WeatherLayers.FrontType.STATIONARY,
    };

    function secToDeg(value) {
      return value / 60 / 60;
    }

    window.addEventListener('DOMContentLoaded', async () => {
      const config = await initConfig({ deckgl: true, webgl2: true });
      let gui;

      // deck.gl
      const deckgl = window.deckgl = new deck.Deck({
        parent: document.getElementById('deck'),
        initialViewState: {
          longitude: 30,
          latitude: 0,
          zoom: 0,
        },
        controller: {
          normalize: false,
        },
        views: [
          new deck.MapView({ repeat: true }),
        ],
        layers: [],
      });

      // info panels
      const infoControl = new InfoControl();
      infoControl.prependTo(document.getElementById('top-left'));
      deckgl.setProps({ onViewStateChange: ({ viewState }) => infoControl.update(viewState) });

      // attribution
      const basemapAttributionControl = new WeatherLayers.AttributionControl({ attribution: '© <a href="https://www.jawg.io">Jawg</a> © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' });
      basemapAttributionControl.prependTo(document.getElementById('bottom-right'));

      // FPS meter
      const fpsControl = new FpsControl();
      fpsControl.prependTo(document.getElementById('bottom-right'));

      // config
      async function update() {
        const image = await WeatherLayers.loadTextureData('front-pressure.byte.png');
        const imageType = WeatherLayers.ImageType.SCALAR;
        const imageUnscale = [940, 1080];
        const bounds = [-180, -90, 180, 90];
        const palette = "940	238	238	238\n948	255	51	255\n956	157	19	157\n964	40	29	102\n973	88	82	163\n981	67	121	183\n989	80	173	131\n997	107	193	83\n1005	195	212	64\n1013	213	182	61\n1021	212	134	72\n1030	200	73	109\n1038	158	45	90\n1046	109	27	50\n1054	47	7	8\n1070	47	7	8";
        const unitFormat = {unit: "hPa"};

        deckgl.setProps({
          layers: [
            new deck.TileLayer({
              id: 'basemap',
              data: 'https://tile.jawg.io/jawg-dark/{z}/{x}/{y}.png?lang=en&access-token=L65oyoBsBEB9LmzFMCJLhM1Mk8stGaEF5Lhq0pKQEdJWyqDQ2o8CCHfkePgO2brE',
              minZoom: 0,
              maxZoom: 22,
              tileSize: 256,
              renderSubLayers: props => {
                const {bbox: {west, south, east, north}} = props.tile;
                return new deck.BitmapLayer(props, {
                  data: null,
                  image: props.data,
                  bounds: [west, south, east, north],
                });
              },
            }),
            new WeatherLayers.RasterLayer({
              id: 'raster',
              // data properties
              image,
              imageSmoothing: config.imageSmoothing,
              imageInterpolation: config.imageInterpolation,
              imageType,
              imageUnscale,
              bounds,
              // style properties
              visible: config.raster.enabled,
              palette,
              opacity: config.raster.opacity,
              extensions: [new deck.ClipExtension()],
              clipBounds: [-181, -85.051129, 181, 85.051129],
            }),
            new WeatherLayers.ContourLayer({
              id: 'contour',
              // data properties
              image,
              imageSmoothing: config.imageSmoothing,
              imageInterpolation: config.imageInterpolation,
              imageType,
              imageUnscale,
              bounds,
              // style properties
              visible: config.contour.enabled,
              interval: config.contour.interval,
              width: config.contour.width,
              color: colorToArray(config.contour.color),
              opacity: config.contour.opacity,
              extensions: [new deck.ClipExtension()],
              clipBounds: [-181, -85.051129, 181, 85.051129],
            }),
            new WeatherLayers.HighLowLayer({
              id: 'highLow',
              // data properties
              image,
              imageSmoothing: config.imageSmoothing,
              imageInterpolation: config.imageInterpolation,
              imageType,
              imageUnscale,
              bounds,
              // style properties
              visible: config.highLow.enabled,
              unitFormat,
              radius: config.highLow.radius,
              textSize: config.highLow.textSize,
              textColor: colorToArray(config.highLow.textColor),
              textOutlineWidth: config.highLow.textOutlineWidth,
              textOutlineColor: colorToArray(config.highLow.textOutlineColor),
              opacity: config.highLow.opacity,
            }),
            new WeatherLayers.FrontLayer({
              id: 'front',
              // data properties
              data: FRONT_DATA.FT[6].obj, // 5, 6+, 10, 11, 12, 14+, 17+, 18
              getPath: d => d.point.map(point => [secToDeg(point.LON), secToDeg(point.LAT)]),
              getFrontType: d => FrontDataTypeToFrontType[d.TYPE],
            }),
          ],
        });
      }
      update();
      gui = initGui(config, update, { deckgl, webgl2: true });
    });
  </script>
</body>

</html>