<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>kamzek-weather</title>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="https://unpkg.com/deck.gl@8.4.13/dist.min.js"></script>
    <script src="https://unpkg.com/@luma.gl/constants@8.4.4/dist/dist.min.js"></script>
    <script src="https://unpkg.com/deck.gl-leaflet@1.0.4/dist/deck.gl-leaflet.min.js"></script>
    <script src="./deck.gl-raster.min.js"></script>
    <script src="../dist/weather-gl.umd.min.js"></script>
    <link href="./style.css" rel="stylesheet">
</head>
<body>
    <div id="container">
        <div id="leaflet"></div>
    </div>
    <div id="info">
        <div id="info1"></div>
        <div id="info2"></div>
    </div>

<script type="module">
import { getUrl, colorFunctions, loadConfig, initGui } from './config.js';

function formatNumber(value, decimals = 6) {
    return Math.floor(value * 10 ** decimals) / 10 ** decimals;
}

window.addEventListener('DOMContentLoaded', async () => {
    const config = await loadConfig();

    const map = L.map('leaflet', {
        center: [0, 30],
        zoom: 0,
        zoomSnap: 0.001,
        zoomControl: false,
    });
    L.vectorGrid.slicer({ type: 'GeometryCollection', geometries: [{ type: 'Polygon', coordinates: [[[-180, 90], [0, 90], [180, 90], [180, -90], [0, -90], [-180, -90]]] }]}, {
        rendererFactory: L.canvas.tile,
        vectorTileLayerStyles: {
            sliced: () => ({
                stroke: false,
                fill: true,
                fillColor: 'rgb(26, 26, 26)',
                fillOpacity: 1,
            }),
        },
    }).addTo(map);
    L.vectorGrid.slicer(await (await fetch('https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_50m_admin_0_countries.geojson')).json(), {
        rendererFactory: L.canvas.tile,
        vectorTileLayerStyles: {
            sliced: () => ({
                stroke: true,
                weight: 1,
                color: 'rgb(61, 61, 61)',
                fill: true,
                fillColor: 'rgb(51, 51, 51)',
                fillOpacity: 1,
            }),
        },
    }).addTo(map);

    let legendControl;

    function updateInfo() {
        const bounds = map.getBounds();

        document.getElementById('info1').innerHTML = `
            Center: ${L.GeoJSON.latLngToCoords(map.getCenter()).map(x => formatNumber(x)).join(', ')}<br>
            Zoom: ${formatNumber(map.getZoom())}<br>
            <br>
            Bounds:<br>
            <div class="grid-2">
                ${L.GeoJSON.latLngToCoords(bounds.getSouthWest()).map((x, i, array) => `<span>${formatNumber(x)}${i < array.length - 1 ? ',' : ''}</span>`).join('')}
                ${L.GeoJSON.latLngToCoords(bounds.getNorthEast()).map((x, i, array) => `<span>${formatNumber(x)}${i < array.length - 1 ? ',' : ''}</span>`).join('')}
            </div><br>
        `;
    };
    function updateMouseInfo(event) {
        // TODO: RasterLayer picking, see https://github.com/kylebarron/deck.gl-raster/issues/32
        const overlayValue = undefined; // overlayLayer ? overlayLayer.getPositionValue(event.latlng) : undefined;
        const particlesVector = undefined; // particlesLayer ? particlesLayer.getPositionVector(event.latlng) : undefined;
        const particlesBearing = undefined; // particlesLayer ? particlesLayer.getPositionBearing(event.latlng) : undefined;

        document.getElementById('info2').innerHTML = `
            Mouse:<br>
            Position: ${L.GeoJSON.latLngToCoords(event.latlng).map(x => formatNumber(x)).join(', ')}<br>
            Overlay Value: ${typeof overlayValue !== 'undefined' ? formatNumber(overlayValue) : 'n/a'}<br>
            Particles Vector: ${typeof particlesVector !== 'undefined' ? `${formatNumber(particlesVector[0])}, ${formatNumber(particlesVector[1])}` : 'n/a'}<br>
            Particles Bearing: ${typeof particlesBearing !== 'undefined' ? Math.round(particlesBearing) : 'n/a'}
        `;
    }
    map.on('move', updateInfo);
    map.on('zoom', updateInfo);
    map.on('resize', updateInfo);
    map.on('mousemove', updateMouseInfo);
    updateInfo();

    const deckLayer = new DeckGlLeaflet.LeafletLayer({
        layers: [],
    });
    map.addLayer(deckLayer);

    // function updateInfo() {
    //     document.getElementById('info1').innerHTML = `
    //         Center: ${map.getCenter().toArray().map(x => formatNumber(x)).join(', ')}<br>
    //         Zoom: ${formatNumber(map.getZoom())}<br>
    //         Pitch: ${formatNumber(map.getPitch())}<br>
    //         Bearing: ${formatNumber(map.getBearing())}<br>
    //         <br>
    //         Bounds:<br>
    //         <div class="grid-2">
    //             ${map.getBounds().getSouthWest().toArray().map((x, i, array) => `<span>${formatNumber(x)}${i < array.length - 1 ? ',' : ''}</span>`).join('')}
    //             ${map.getBounds().getNorthEast().toArray().map((x, i, array) => `<span>${formatNumber(x)}${i < array.length - 1 ? ',' : ''}</span>`).join('')}
    //         </div><br>
    //     `;
    // };
    // function updateMouseInfo(event) {
    //     // TODO: RasterLayer picking, see https://github.com/kylebarron/deck.gl-raster/issues/32
    //     const overlayValue = undefined; // overlayLayer ? overlayLayer.getPositionValue(event.lngLat) : undefined;
    //     const particlesVector = undefined; // particlesLayer ? particlesLayer.getPositionVector(event.lngLat) : undefined;
    //     const particlesBearing = undefined; // particlesLayer ? particlesLayer.getPositionBearing(event.lngLat) : undefined;

    //     document.getElementById('info2').innerHTML = `
    //         Mouse:<br>
    //         Position: ${formatNumber(event.lngLat.lng)}, ${formatNumber(event.lngLat.lat)}<br>
    //         Overlay Value: ${typeof overlayValue !== 'undefined' ? formatNumber(overlayValue) : 'n/a'}<br>
    //         Particles Vector: ${typeof particlesVector !== 'undefined' ? `${formatNumber(particlesVector[0])}, ${formatNumber(particlesVector[1])}` : 'n/a'}<br>
    //         Particles Bearing: ${typeof particlesBearing !== 'undefined' ? Math.round(particlesBearing) : 'n/a'}
    //     `;
    // }
    // map.on('move', updateInfo);
    // map.on('zoom', updateInfo);
    // map.on('resize', updateInfo);
    // map.on('mousemove', updateMouseInfo);
    // updateInfo();

    // weather layers
    async function update() {
        const overlayUrl = getUrl(config.datasets, config.meta.dataset, config.meta.datetime);
        const particlesUrl = getUrl(config.datasets, config.meta.particles.dataset, config.meta.particles.datetime);
        config.overlay.colorFunction = colorFunctions.get(config.meta.overlay.colorFunction);
        const overlay = await loaders.load(overlayUrl, loaders.ImageLoader);
        const colormap = await createImageBitmap(WeatherGl.colorRampCanvas(config.overlay.colorFunction));

        if (!legendControl) {
            legendControl = new WeatherGl.LegendControl(config.overlay);
            const container = legendControl.onAdd();
            container.style.position = 'absolute';
            container.style.bottom = '10px';
            container.style.left = '10px';
            document.body.appendChild(container);
        } else {
            legendControl.update();
        }

        deckLayer.setProps({
            layers: [
                new deck['gl-raster'].RasterLayer({
                    id: 'raster',
                    images: {
                        imageRgba: {
                            data: overlay,
                            format: luma.default.RGB,
                            parameters: {
                                [luma.default.TEXTURE_MIN_FILTER]: luma.default.LINEAR,
                                [luma.default.TEXTURE_MAG_FILTER]: luma.default.LINEAR,
                            },
                        },
                        imageColormap: {
                            data: colormap,
                            format: luma.default.RGB,
                            parameters: {
                                [luma.default.TEXTURE_MIN_FILTER]: luma.default.LINEAR,
                                [luma.default.TEXTURE_MAG_FILTER]: luma.default.LINEAR,
                            },
                        },
                        imageMask: {
                            data: overlay,
                            format: luma.default.ALPHA,
                            parameters: {
                                [luma.default.TEXTURE_MIN_FILTER]: luma.default.LINEAR,
                                [luma.default.TEXTURE_MAG_FILTER]: luma.default.LINEAR,
                            },
                        },
                    },
                    modules: [
                        deck['gl-raster'].rgbaImage,
                        ...(config.overlay.vector ? [
                            deck['gl-raster'].linearRescale,
                            deck['gl-raster'].length,
                        ] : []),
                        deck['gl-raster'].colormap,
                        deck['gl-raster'].maskImage,
                    ],
                    moduleProps: {
                        linearRescaleScaler: 2,
                        linearRescaleOffset: -1,
                        colormapScaler: 1,
                        colormapOffset: 0,
                    },
                    bounds: [-180, -90, 180, 90],
                    opacity: config.overlay.opacity,
                    _imageCoordinateSystem: deck.COORDINATE_SYSTEM.LNGLAT,
                }),
            ],
        });
    }
    update();

    // GUI
    const meta = {
        running: true,
        step: () => undefined, // particlesLayer.step(),
    };
    const gui = initGui(config, update);
    const debug = gui.addFolder('debug');
    debug.add(meta, 'running').onChange(() => {
        // if (meta.running) {
        //     particlesLayer.start();
        // } else {
        //     particlesLayer.stop();
        // }
    });
    debug.add(meta, 'step');
});
</script>
</body>
</html>